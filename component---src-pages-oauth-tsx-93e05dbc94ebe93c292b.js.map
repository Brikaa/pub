{"version":3,"sources":["webpack:///./src/pages/oauth.tsx"],"names":["OauthPage","location","useLocation","siteMetadata","useSiteMetadata","useState","message","setMessage","useEffect","a","searchParams","URLSearchParams","search","stateParam","get","codeParam","workspaceId","workspace","perms","permissions","oauthState","getLocalStorage","Object","keys","length","workspaceAppAuth","code","project","projectId","workspaceService","ServiceResolver","workspaceServiceResolver","finishAuth","workspaceType","removeLocalStorage","navigate","redirectUrl","title","description","urlSlug"],"mappings":"iPAyGeA,UAvFO,WACpB,IAAMC,EAAWC,wBACXC,EAAeC,cAFK,EAGIC,mBAAS,+BAAhCC,EAHmB,KAGVC,EAHU,KAsE1B,OAjEAC,qBAAU,WAAM,4CACd,8CAAAC,EAAA,yDACQC,EAAe,IAAIC,gBAAgBV,EAASW,QAC5CC,EAAaH,EAAaI,IAAI,SAC9BC,EAAYL,EAAaI,IAAI,QAEhB,OAAfD,EALN,uBAMIN,EACE,gIAPN,6BAYoB,OAAdQ,EAZN,uBAaIR,EACE,+HAdN,6BAmBMS,EAAc,GAEA,QADZC,EAAYP,EAAaI,IAAI,eAEjCE,EAAcC,GAGZC,EAAQ,GAEQ,QADdC,EAAcT,EAAaI,IAAI,kBAEnCI,EAAQC,GAGJC,EAAaC,YAA4BR,GAER,IAAnCS,OAAOC,KAAKH,GAAYI,OAjC9B,wBAkCIjB,EACE,uNAnCN,kCAwCQkB,EAAqC,CACzCC,KAAMX,EACNY,QAASP,EAAWQ,UACpBX,UAAWD,EACXG,YAAaD,GA5CjB,UAgDUW,EAAmBC,kBAAgBC,2BAhD7C,UAiDUF,EAAiBG,WACrBZ,EAAWa,cACXR,GAnDN,2DAsDIlB,EAAW,KAAMD,SAtDrB,QAyDE4B,YAAmBrB,GACnBsB,mBAASf,EAAWgB,aA1DtB,4DADc,0DA8DdJ,KACC,CAAC/B,EAASW,SAGX,kBAAC,IAAD,KACE,kBAAC,IAAD,CACEyB,MAAK,QACLC,YAAW,kBAAoBnC,EAAakC,MAAjC,WACXE,QAAQ,WAEV,kBAAC,IAAD,KACE,kBAAC,IAAD,iCACA,kBAAC,IAAD,KACE,2BAAIjC","file":"component---src-pages-oauth-tsx-93e05dbc94ebe93c292b.js","sourcesContent":["import React, { FC, useState, useEffect } from 'react';\nimport { useLocation } from '@reach/router';\nimport { navigate } from 'gatsby';\nimport { useSiteMetadata } from '@hooks';\n\nimport {\n  Container,\n  Layout,\n  PageTitle,\n  PageBody,\n  Seo,\n} from '@components/shared';\nimport { getLocalStorage, removeLocalStorage } from '@utils';\nimport { OauthState } from '@components/projects';\nimport { WorkspaceAppAuth } from '@api/types';\nimport { ServiceResolver } from '@api';\n\n/* Page supports oauth authorization flow */\nconst OauthPage: FC = () => {\n  const location = useLocation();\n  const siteMetadata = useSiteMetadata();\n  const [message, setMessage] = useState('Waiting to be redirected...');\n\n  useEffect(() => {\n    async function finishAuth() {\n      const searchParams = new URLSearchParams(location.search);\n      const stateParam = searchParams.get('state');\n      const codeParam = searchParams.get('code');\n\n      if (stateParam === null) {\n        setMessage(\n          'Invalid state param. This may have happened if you visited this page directly. Try installing the app from the project page.',\n        );\n        return;\n      }\n\n      if (codeParam === null) {\n        setMessage(\n          'Invalid code param. This may have happened if you visited this page directly. Try installing the app from the project page.',\n        );\n        return;\n      }\n\n      let workspaceId = '';\n      const workspace = searchParams.get('guild_id');\n      if (workspace !== null) {\n        workspaceId = workspace;\n      }\n\n      let perms = '';\n      const permissions = searchParams.get('permissions');\n      if (permissions !== null) {\n        perms = permissions;\n      }\n\n      const oauthState = getLocalStorage<OauthState>(stateParam);\n\n      if (Object.keys(oauthState).length === 0) {\n        setMessage(\n          'Invalid stored state. The app may already be installed on your workspace or you may have tried installing the app directly. Try installing the app from the project page. If the problem persists send us feedback.',\n        );\n        return;\n      }\n\n      const workspaceAppAuth: WorkspaceAppAuth = {\n        code: codeParam,\n        project: oauthState.projectId,\n        workspace: workspaceId,\n        permissions: perms,\n      };\n\n      try {\n        const workspaceService = ServiceResolver.workspaceServiceResolver();\n        await workspaceService.finishAuth(\n          oauthState.workspaceType,\n          workspaceAppAuth,\n        );\n      } catch (error) {\n        setMessage(error.message);\n      }\n\n      removeLocalStorage(stateParam);\n      navigate(oauthState.redirectUrl);\n    }\n\n    finishAuth();\n  }, [location.search]);\n\n  return (\n    <Layout>\n      <Seo\n        title={`Oauth`}\n        description={`Oauth page for ${siteMetadata.title} website`}\n        urlSlug=\"oauth/\"\n      />\n      <Container>\n        <PageTitle>Finishing app install...</PageTitle>\n        <PageBody>\n          <p>{message}</p>\n        </PageBody>\n      </Container>\n    </Layout>\n  );\n};\n\nexport default OauthPage;\n"],"sourceRoot":""}